const express=require("express"),bodyParser=require("body-parser"),request=require("request"),app=express();app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json());let pedidoCliente={pedido:"",cliente:"",direccion:"",telefono:"",estado:""},repartidorRestaurante={pedido:"",direccion:"",cliente:"",repartidor:"",estado:""},respuesta={error:!1,codigo:200,mensaje:""};app.get("/",(function(e,o){respuesta={error:!1,codigo:200,mensaje:"Punto de inicio"},o.send(respuesta)})),app.route("/pedidos").get((function(e,o){console.log("Cliente esta solicitando estado de su pedido..'"),""===pedidoCliente.pedido||""===pedidoCliente.cliente?respuesta={error:!0,codigo:501,mensaje:"El pedido no ha sido creado"}:(console.log("Solicitando estado del pedido al Restaurante.'"),request("http://localhost:4000/pedidos",{json:!0},(e,o)=>{if(e)return console.log(e);e||200!=o.statusCode||(console.log(o.body),pedidoCliente={pedido:o.body.pedido,cliente:o.body.cliente,estado:o.body.estado,direccion:o.body.direccion,telefono:o.body.telefono},respuesta={error:!1,codigo:200,mensaje:"Enviando estado de pedido al cliente...",respuesta:pedidoCliente})})),o.send(respuesta)})).post((function(e,o){e.body.pedido&&e.body.cliente?(console.log("Recibido nuevo pedido de cliente...'"),pedidoCliente={pedido:e.body.pedido,cliente:e.body.cliente,direccion:e.body.direccion,telefono:e.body.telefono,estado:e.body.estado},respuesta={error:!1,codigo:200,mensaje:"Recibido nuevo pedido de cliente...",respuesta:pedidoCliente},console.log("Enviando solicitud al Restaurante...'"),request.post("http://localhost:4000/pedidos",{json:{pedido:pedidoCliente.pedido,cliente:pedidoCliente.cliente,direccion:pedidoCliente.direccion,telefono:pedidoCliente.telefono,estado:pedidoCliente.estado}},(e,o,d)=>{e?console.error(e):(console.log("statusCode: "+o.statusCode),console.log(d))})):respuesta={error:!0,codigo:502,mensaje:"El campo pedido y cliente son requeridos"},o.send(respuesta)})),app.route("/repartidores").get((function(e,o){console.log("Cliente esta solicitando estado de la entrega de su pedido...'"),""===repartidorRestaurante.pedido||""===repartidorRestaurante.cliente||""===repartidorRestaurante.direccion?respuesta={error:!0,codigo:501,mensaje:"No hay entrega de producto solicitado"}:(console.log("Solicitando estado al Repartaritor desde el ESB.'"),request("http://localhost:5000/repartidores",{json:!0},(e,o)=>{if(e)return console.log(e);e||200!=o.statusCode||(console.log(o.body),repartidorRestaurante={repartidor:o.body.repartidor,estado:o.body.estado},respuesta={error:!1,codigo:200,mensaje:"Enviando estado de entrega de pedido al cliente desde el ESB...",respuesta:repartidorRestaurante})})),o.send(respuesta)})).post((function(e,o){e.body.pedido&&e.body.cliente&&e.body.direccion?(console.log("Recibiendo nueva solicitud de entrega del restaurante mediante ESB'"),repartidorRestaurante={pedido:e.body.pedido,cliente:e.body.cliente,direccion:e.body.direccion},respuesta={error:!1,codigo:200,mensaje:"Recibido nueva solicitud de entrega de restaurante...",respuesta:repartidorRestaurante},console.log("Enviando solicitud de entrega a Repartidor..'"),request.post("http://localhost:5000/repartidores",{json:{pedido:repartidorRestaurante.pedido,cliente:repartidorRestaurante.cliente,direccion:repartidorRestaurante.direccion}},(e,o,d)=>{e?console.error(e):(console.log("statusCode: "+o.statusCode),console.log(d))})):respuesta={error:!0,codigo:502,mensaje:"El campo pedido y cliente y direccion son requeridos"},o.send(respuesta)})),app.listen(3e3,()=>{console.log("Microservicio ESB est√° inicializado en el puerto 3000")});